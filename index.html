<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VERA — Speak with the Neuro Orb</title>
  <meta name="description" content="Tap the Neuro Orb to speak with VERA. Voice-guided somatic intelligence with a living, audio-reactive nervous-system interface." />

  <style>
    :root{
      --bg0:#050815; --bg1:#0a1024; --bg2:#0d1636;
      --ink1:rgba(255,255,255,.95); --ink2:rgba(255,255,255,.72); --ink3:rgba(255,255,255,.48);
      --lav:#B19CD9; --vio:#9B59B6; --sky:#64B5F6; --mint:#10B981; --gold:#FFD700; --pink:#F8BBD0;
      --glass:rgba(255,255,255,.06); --glass-b:rgba(255,255,255,.14);
      --charge:0;  /* 0..1 from audio analyser */
      --listen:0;  /* 0 or 1 when listening */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1400px 900px at 15% -10%, #1d2751 0%, #0a0f28 40%, #050815 70%, #01040b 100%);
      color:var(--ink1); font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Ubuntu,sans-serif;
      overflow-x:hidden;
    }
    /* Top bar */
    .banner{
      position:fixed; inset:0 auto auto 0; width:100%; padding:.6rem 1rem; text-align:center; z-index:9999;
      background:linear-gradient(90deg, #FFD700, #FF9A3D); color:#111; font-weight:800; letter-spacing:.02em;
      box-shadow:0 8px 30px rgba(0,0,0,.35);
    }
    nav{
      position:fixed; top:44px; left:0; right:0; z-index:9998;
      display:flex; align-items:center; justify-content:space-between; gap:1rem;
      padding:1rem 2rem; border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(6,8,21,.85), rgba(6,8,21,.55));
      backdrop-filter:saturate(150%) blur(16px);
    }
    .brand{
      font-weight:900; letter-spacing:.28em; font-size:1.25rem; cursor:pointer;
      background:linear-gradient(120deg, var(--gold), var(--lav), var(--sky)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .menu{display:flex; gap:1.2rem; align-items:center}
    .menu a{color:var(--ink2); text-decoration:none; font-weight:700}
    .menu a:hover{color:#fff}
    .cta{border:none; padding:.7rem 1.1rem; border-radius:999px; cursor:pointer; font-weight:800;
      background:linear-gradient(135deg, var(--lav), var(--sky)); color:#fff; box-shadow:0 12px 40px rgba(100,181,246,.25);
    }

    /* Background canvas (neurons) + glow wash */
    #neuroCanvas{position:fixed; inset:0; z-index:0}
    .glow{
      pointer-events:none; position:fixed; inset:0; z-index:0;
      background:
        radial-gradient(900px 700px at 80% 10%, rgba(155,89,182,.18), transparent 60%),
        radial-gradient(1000px 1000px at 20% 80%, rgba(100,181,246,.16), transparent 70%),
        radial-gradient(700px 700px at 60% 60%, rgba(16,185,129,.14), transparent 70%);
      filter:saturate(calc(1 + var(--charge) * .6)) brightness(calc(1 + var(--charge) * .4));
      transition:filter .25s ease;
    }

    /* HERO with Neuro Orb */
    .hero{
      position:relative; z-index:1; padding-top:160px; padding-bottom:40px; min-height:92vh;
      display:grid; place-items:center;
    }
    .hero-inner{max-width:1100px; padding:0 16px; text-align:center}
    h1{
      margin:0 0 10px; font-size:clamp(2.2rem,5.6vw,4.6rem); line-height:1.04; font-weight:900; letter-spacing:.01em;
      background:conic-gradient(from 30deg at 50% 50%, #fff, var(--lav), var(--sky), #fff);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 60px rgba(155,89,182,.25);
    }
    .sub{color:var(--ink2); font-size:clamp(1.05rem,2.2vw,1.35rem); line-height:1.7; margin:0 0 24px}
    .note{color:var(--ink3); font-size:.95rem}

    /* Neuro Orb — button */
    .orb-wrap{position:relative; width:min(72vw, 520px); aspect-ratio:1; margin:28px auto}
    .orb{
      position:absolute; inset:0; border-radius:50%;
      background:
        radial-gradient(120% 120% at 30% 30%, rgba(248,187,208,.45), transparent 60%),
        radial-gradient(120% 120% at 70% 50%, rgba(100,181,246,.40), transparent 62%),
        radial-gradient(140% 140% at 40% 80%, rgba(177,156,217,.32), transparent 60%),
        radial-gradient(closest-side, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.22);
      box-shadow:
        0 0 calc(80px + 80px*var(--charge)) rgba(155,89,182,.35),
        inset 0 0 calc(60px + 40px*var(--charge)) rgba(100,181,246,.28);
      cursor:pointer; transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      transform:scale(calc(1 + var(--charge) * .08)) translateZ(0);
      outline:none;
    }
    .orb:hover{border-color:rgba(255,255,255,.35); transform:scale(calc(1.02 + var(--charge) * .07))}
    .ring, .ring::before, .ring::after{
      position:absolute; inset:6%; border-radius:50%;
      border:1px dashed rgba(255,255,255,.15); content:"";
      mask:radial-gradient(circle, transparent 58%, #000 59%);
      pointer-events:none;
    }
    .ring{animation:spin 24s linear infinite}
    .ring::before{inset:10%; animation:spin 38s linear infinite reverse; opacity:.7}
    .ring::after{inset:14%; animation:spin 56s linear infinite; opacity:.5}
    @keyframes spin{to{transform:rotate(360deg)}}

    .axons{
      position:absolute; inset:0; border-radius:50%; overflow:hidden; pointer-events:none;
      filter:blur(0.6px) saturate(1.2);
      background:
        conic-gradient(from 0deg, rgba(177,156,217,.12), rgba(100,181,246,.12), rgba(248,187,208,.12), rgba(16,185,129,.10), rgba(177,156,217,.12));
      mask:radial-gradient(circle at 50% 50%, #000 62%, transparent 63%);
      animation:axons 16s ease-in-out infinite;
      opacity:.75;
    }
    @keyframes axons{
      0%,100%{transform:rotate(0) scale(1)}
      50%{transform:rotate(10deg) scale(1.02)}
    }

    .badge{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      font-weight:200; letter-spacing:.6em; font-size:clamp(1.2rem, 3.4vw, 2.6rem);
      background:linear-gradient(120deg, var(--gold), var(--lav), var(--sky)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      pointer-events:none;
    }

    .status{
      text-align:center; margin-top:18px; min-height:28px; color:var(--ink2);
    }
    .status .dot{
      display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px;
      background:linear-gradient(120deg, var(--lav), var(--sky));
      box-shadow:0 0 0 calc(8px*var(--listen)) rgba(100,181,246,.15);
      transition:box-shadow .25s ease;
    }

    .subtitle{
      position:absolute; left:50%; bottom:12%; transform:translateX(-50%);
      padding:10px 14px; border-radius:12px; backdrop-filter:blur(10px);
      background:rgba(8,10,22,.55); border:1px solid rgba(255,255,255,.18);
      color:#fff; font-size:1rem; max-width:min(80%, 560px);
      opacity:0; transition:opacity .25s ease;
      pointer-events:none;
    }
    .subtitle.show{opacity:1}

    /* Sections (plans + experiences) */
    section{position:relative; z-index:1}
    .stack{max-width:1150px; margin:0 auto; padding:80px 16px}
    h2.title{
      margin:0 0 16px; font-weight:900; letter-spacing:.04em; font-size:clamp(1.7rem, 3.8vw, 2.6rem);
      background:linear-gradient(120deg, #fff, var(--lav), var(--sky), #fff);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .grid{display:grid; grid-template-columns:repeat(4, minmax(220px,1fr)); gap:16px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.grid{grid-template-columns:1fr}}
    .card{
      padding:22px; border-radius:16px;
      background:linear-gradient(160deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
    }
    .price{font-size:2rem; font-weight:900}
    .muted{color:var(--ink2)}

    footer{padding:60px 16px; border-top:1px solid rgba(255,255,255,.08); text-align:center; color:var(--ink3)}
  </style>
</head>
<body>
  <div class="banner">⚠️ TEST MODE — Use Stripe test card 4242 4242 4242 4242 (any future date & CVC)</div>

  <nav>
    <div class="brand" onclick="location.href='/'">VERA</div>
    <div class="menu">
      <a href="#plans">Plans</a>
      <a href="#experiences">Guides</a>
      <button class="cta" onclick="alert('Beta access coming soon ✨')">Join Beta</button>
    </div>
  </nav>

  <!-- Living background -->
  <canvas id="neuroCanvas" aria-hidden="true"></canvas>
  <div class="glow" aria-hidden="true"></div>

  <!-- HERO with Neuro Orb -->
  <header class="hero">
    <div class="hero-inner">
      <h1>Tap the Orb • Speak with VERA</h1>
      <p class="sub">A living, audio-reactive nervous-system interface. Tap to start, grant mic permission, and just talk. VERA answers out loud.</p>

      <div class="orb-wrap">
        <button class="orb" id="orb" aria-label="Talk to VERA">
          <div class="ring"></div>
          <div class="axons"></div>
          <div class="badge">V E R A</div>
          <div class="subtitle" id="subtitle"></div>
        </button>
      </div>
      <div class="status"><span class="dot"></span><span id="statusText">Idle — tap to begin</span></div>

      <p class="note">If your browser doesn’t support speech recognition, VERA will show a minimal text prompt fallback.</p>
    </div>
  </header>

  <!-- Plans -->
  <section id="plans" class="stack">
    <h2 class="title">Choose Your Portal</h2>
    <div class="grid">
      <div class="card"><strong>EXPLORER</strong><div class="price">$19<span style="opacity:.7;font-size:.9rem">/mo</span></div><p class="muted">Daily check-ins • Core conversations • 3 guided practices/day</p></div>
      <div class="card"><strong>REGULATOR</strong> <span style="font-size:.75rem;background:linear-gradient(120deg, var(--gold), #ffb84d);color:#111;padding:.2rem .5rem;border-radius:999px;margin-left:8px;">POPULAR</span><div class="price">$39<span style="opacity:.7;font-size:.9rem">/mo</span></div><p class="muted">Unlimited conversations • Advanced protocols • Voice + HRV</p></div>
      <div class="card"><strong>INTEGRATOR</strong><div class="price">$79<span style="opacity:.7;font-size:.9rem">/mo</span></div><p class="muted">Everything in Regulator • 1:1 monthly • Custom trauma maps</p></div>
      <div class="card"><strong>ENTERPRISE</strong><div class="price">Custom</div><p class="muted">Org-wide deployment • HIPAA + SSO • Dedicated success</p></div>
    </div>
  </section>

  <!-- Experiences -->
  <section id="experiences" class="stack">
    <h2 class="title">Guided Micro-Practices</h2>
    <div class="grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="card">
        <h3>Breath Cadence 4-4-6</h3>
        <p class="muted">A gentle cadence. Turn voice on by tapping the orb first.</p>
        <button class="cta" onclick="guideBreath()">Play Guide</button>
      </div>
      <div class="card">
        <h3>Sway Protocol</h3>
        <p class="muted">“Kelp in warm water” patterning to discharge sympathetic energy.</p>
        <button class="cta" onclick="speak('Let your body sway gently. Like kelp in warm water. No forcing, just allowing. Your spine knows how to move.')">Play Guide</button>
      </div>
      <div class="card">
        <h3>5-4-3-2-1 Ground</h3>
        <p class="muted">Evidence of safety for the midbrain.</p>
        <button class="cta" onclick="speak('Notice five things you can see. Four you can touch. Three you can hear. Two you can smell. One you can taste. You are here. You are safe.')">Play Guide</button>
      </div>
    </div>
  </section>

  <footer>
    © 2024 VERA Technologies • Educational only, not medical advice • Your data is encrypted end-to-end.
  </footer>

  <!-- Audio for ElevenLabs playback -->
  <audio id="veraAudio" preload="auto"></audio>

  <script>
    /* ---------- DOM helpers ---------- */
    const $ = q => document.querySelector(q);

    const orb = $('#orb');
    const statusText = $('#statusText');
    const statusDot = document.querySelector('.status .dot');
    const subtitle = $('#subtitle');
    const audioEl = $('#veraAudio');

    /* ---------- State ---------- */
    let listening = false;
    let greeted = false;
    let speechOK = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    let Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog = null;

    /* ---------- ElevenLabs speak (with browser fallback) ---------- */
    const cache = new Map(); // text -> blobURL
    async function speak(text){
      showSubtitle(text, false);
      try{
        if(cache.has(text)){ audioEl.src = cache.get(text); await audioEl.play().catch(()=>{}); return; }
        const r = await fetch('/api/vera-voice',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        if(!r.ok) throw new Error('TTS proxy failed');
        const b = await r.blob(); const url = URL.createObjectURL(b);
        cache.set(text, url); audioEl.src = url; await audioEl.play().catch(()=>{});
        setTimeout(()=>URL.revokeObjectURL(url), 30000);
      }catch(e){
        if('speechSynthesis' in window){ const u = new SpeechSynthesisUtterance(text); u.rate=.95; u.pitch=1.05; speechSynthesis.speak(u); }
      }
    }

    /* ---------- Simple body-intel replies ---------- */
    function replyFor(text){
      const t = (text||'').toLowerCase();
      const bank = [
        ['tight', "I feel that tightness with you. Thank it for protecting you. Let it move one millimeter and tell me if it’s dull, sharp, warm or cool."],
        ['chest', "Your chest is speaking. Lift the sternum 1% and breathe around the edges of the sensation. What changes?"],
        ['anx', "Brilliant protection. Press your feet into the floor for two slow breaths. From 1–10, where is the charge now?"],
        ['relax', "Try contrast: clench your hands for two seconds, then melt them open. Notice the difference in your system."],
        ['safe', "Safety is evidence. Name five things you can see, four you can touch, three you hear, two you smell, one you taste. I’m here."],
        ['help', "I’m here. Where is it — left/right, front/back, surface/deep? Give me three words for its texture."]
      ];
      for(const [k,v] of bank){ if(t.includes(k)) return v; }
      return "I’m listening. Where is it located — front/back, left/right, surface/deep? The more specific we are, the faster it unwinds.";
    }

    /* ---------- Recognizer ---------- */
    function startRecognizer(){
      if(!speechOK) return fallbackPrompt();
      if(recog) stopRecognizer(true);
      recog = new Recognition();
      recog.lang = 'en-US'; recog.continuous = false; recog.interimResults = false;
      recog.onstart = ()=>{ setListening(true); setStatus('Listening…'); };
      recog.onresult = (ev)=>{
        const text = (ev.results[0] && ev.results[0][0] && ev.results[0][0].transcript) || '';
        if(text){ showSubtitle(text, true); processUser(text); }
      };
      recog.onerror = ()=>{ setStatus('Mic error. Tap again or use text fallback.'); setListening(false); };
      recog.onend = ()=>{
        // if still “on”, auto-restart after VERA finishes speaking
        if(listening){ /* wait for audio end to restart */ }
      };
      try{ recog.start(); }catch(e){ /* ignore rapid restarts */ }
    }
    function stopRecognizer(silent){
      try{ recog && recog.stop(); }catch(e){}
      if(!silent) setListening(false);
      recog = null;
    }

    /* ---------- Conversation flow ---------- */
    function showSubtitle(text, isUser){
      subtitle.textContent = (isUser? 'You: ' : 'VERA: ') + text;
      subtitle.classList.add('show');
      clearTimeout(showSubtitle._t);
      showSubtitle._t = setTimeout(()=>subtitle.classList.remove('show'), 6000);
    }
    async function greet(){
      if(greeted) return;
      greeted = true;
      const line = "Hi. I’m here with you. Tell me — what sensation is most alive right now, and where does it live?";
      setStatus('Speaking…');
      await speak(line);
      setStatus('Listening…');
      restartListeningAfterSpeech();
    }
    async function processUser(text){
      setStatus('Thinking…');
      const r = replyFor(text);
      setStatus('Speaking…');
      await speak(r);
      setStatus('Listening…');
      restartListeningAfterSpeech();
    }

    /* After VERA speaks, restart listening if still toggled on */
    function restartListeningAfterSpeech(){
      const resume = ()=>{ if(listening) startRecognizer(); cleanup(); };
      const cleanup = ()=>{
        audioEl.removeEventListener('ended', resume);
        audioEl.removeEventListener('pause', resume);
      };
      audioEl.addEventListener('ended', resume);
      audioEl.addEventListener('pause', resume);
    }

    /* ---------- UI state ---------- */
    function setListening(on){
      listening = !!on;
      document.documentElement.style.setProperty('--listen', on?1:0);
      statusDot.style.boxShadow = on ? '0 0 0 8px rgba(100,181,246,.15)' : '0 0 0 0 rgba(0,0,0,0)';
    }
    function setStatus(t){ statusText.textContent = t; }

    /* Tap the orb to toggle conversation */
    orb.addEventListener('click', async ()=>{
      if(!listening){
        setListening(true);
        setStatus('Starting…');
        await greet();
        // recognition starts inside greet -> after speech ends
      }else{
        setListening(false);
        setStatus('Idle — tap to begin');
        stopRecognizer(true);
      }
    });

    /* ---------- Minimal text fallback if SpeechRecognition missing ---------- */
    function fallbackPrompt(){
      if($('#fallback')) return;
      const wrap = document.createElement('div');
      wrap.id = 'fallback'; wrap.style.marginTop='12px'; wrap.style.textAlign='center';
      wrap.innerHTML = `
        <div style="display:inline-flex; gap:8px; align-items:center; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); padding:8px 10px; border-radius:12px;">
          <input id="fallbackInput" placeholder="Type to talk to VERA…" style="background:transparent;border:none;outline:none;color:#fff;width:260px">
          <button style="border:none;border-radius:10px;padding:8px 10px;font-weight:800;background:linear-gradient(135deg, var(--lav), var(--sky));color:#fff;cursor:pointer">Send</button>
        </div>`;
      orb.parentElement.after(wrap);
      wrap.querySelector('button').onclick = async ()=>{
        const v = (wrap.querySelector('#fallbackInput').value||'').trim(); if(!v) return;
        showSubtitle(v, true);
        await processUser(v);
        wrap.querySelector('#fallbackInput').value='';
      };
      setStatus('Text mode — mic unsupported');
    }

    /* ---------- Audio analyser drives charge ---------- */
    ;(function audioReactive(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const src = ctx.createMediaElementSource(audioEl);
        const analyser = ctx.createAnalyser(); analyser.fftSize = 256;
        src.connect(analyser); analyser.connect(ctx.destination);
        const data = new Uint8Array(analyser.frequencyBinCount);
        function loop(){
          analyser.getByteFrequencyData(data);
          let sum=0; for(let i=0;i<data.length;i++) sum+=data[i];
          const avg = sum/data.length/255;
          document.documentElement.style.setProperty('--charge', (avg*1.25).toFixed(3));
          requestAnimationFrame(loop);
        }
        audioEl.addEventListener('play', ()=>{ if(ctx.state==='suspended') ctx.resume(); loop(); }, {once:true});
      }catch(e){}
    })();

    /* ---------- Neuron canvas background ---------- */
    ;(function neuronField(){
      const c = document.getElementById('neuroCanvas'); const x = c.getContext('2d');
      let W,H,DPR = Math.min(2, devicePixelRatio||1);
      function size(){ W=innerWidth; H=innerHeight; c.width=W*DPR; c.height=H*DPR; c.style.width=W+'px'; c.style.height=H+'px'; x.setTransform(DPR,0,0,DPR,0,0); }
      size(); addEventListener('resize', size);

      const N = Math.min(190, Math.floor((W*H)/12000));
      const pts = Array.from({length:N}, ()=>spawn());
      let mx=-9999,my=-9999; addEventListener('mousemove', e=>{mx=e.clientX; my=e.clientY});
      function spawn(){ const s=.2+Math.random()*.8; return {x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*s,vy:(Math.random()-.5)*s,r:1+Math.random()*2}; }
      function step(p){
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<-50||p.x>W+50||p.y<-50||p.y>H+50){ Object.assign(p, spawn()); }
        const dx=p.x-mx, dy=p.y-my, d2=dx*dx+dy*dy; if(d2<16000){ p.vx+=dx*-0.00003; p.vy+=dy*-0.00003; }
      }
      function draw(){
        const g = x.createLinearGradient(0,0,W,H);
        g.addColorStop(0,'rgba(177,156,217,.08)'); g.addColorStop(1,'rgba(100,181,246,.06)');
        x.clearRect(0,0,W,H); x.fillStyle=g; x.fillRect(0,0,W,H);

        const charge=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--charge'))||0;
        const L=120+charge*120;

        for(let i=0;i<N;i++){
          const a=pts[i]; step(a);
          for(let j=i+1;j<N;j++){
            const b=pts[j], dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
            if(d<L){ const o=(1-d/L)*(0.35+charge*0.5); x.strokeStyle=`rgba(155,89,182,${o*.7})`; x.beginPath(); x.moveTo(a.x,a.y); x.lineTo(b.x,b.y); x.stroke(); }
          }
        }
        for(const p of pts){
          x.beginPath(); x.arc(p.x,p.y,p.r+charge*1.2,0,Math.PI*2);
          x.fillStyle=`rgba(100,181,246,${.35+charge*.5})`; x.fill();
        }
        requestAnimationFrame(draw);
      }
      draw();
    })();

    /* ---------- Guides ---------- */
    async function guideBreath(){
      const seq = [
        "Let’s breathe together.",
        "Inhale slowly for four… one… two… three… four.",
        "Hold for four… one… two… three… four.",
        "Exhale for six… one… two… three… four… five… six.",
        "Beautiful."
      ];
      for(const line of seq){ await speak(line); await new Promise(r=>setTimeout(r,150)); }
    }

    /* ---------- Kickoff note ---------- */
    window.addEventListener('load', ()=>{
      setStatus('Idle — tap to begin');
      if(!speechOK){ fallbackPrompt(); }
    });
  </script>
</body>
</html>
