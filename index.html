<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VERA — Somatic Orbit</title>
<meta name="description" content="Talk to VERA. Real-time somatic guidance with voice in/out.">
<style>
  :root{
    --bg:#060818; --ink:#e9ecff; --glass:rgba(255,255,255,.06);
    --glowA:#8ab4ff; --glowB:#b38bff; --glowC:#ffd2f3; --glowD:#a7ffeb;
    --accent:#9b87f5; --muted:#9aa3c7;
  }
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 900px at 50% 12%, #0b0f2a, var(--bg) 55%, #000 100%);
    color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    overflow:hidden;
  }

  .hud{
    position:fixed; inset:16px auto auto 16px; z-index:5; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px 14px; border:1px solid var(--glass); border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    backdrop-filter: blur(10px); box-shadow: 0 12px 40px rgba(0,0,0,.25);
  }
  .hud .badge{font-size:12px; color:var(--muted)}
  .hud button, .hud select{
    appearance:none; border:1px solid var(--glass); background:rgba(255,255,255,.06); color:var(--ink);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
  }

  .wrap{position:absolute; inset:0; display:grid; place-items:center;}
  .field{position:relative; width:min(84vmin,720px); aspect-ratio:1/1; }
  .halo{
    position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(120px 120px at 58% 38%, rgba(255,255,255,.16), transparent 60%),
      radial-gradient(900px 900px at 50% 85%, rgba(138,180,255,.08), transparent 70%),
      radial-gradient(700px 700px at 12% 12%, rgba(179,139,255,.10), transparent 60%),
      radial-gradient(700px 700px at 88% 12%, rgba(167,255,235,.10), transparent 60%);
    box-shadow:
      0 0 140px 40px rgba(138,180,255,.13) inset,
      0 0 220px 40px rgba(179,139,255,.10) inset;
    filter: saturate(1.12);
    transition: box-shadow 320ms ease, filter 320ms ease;
  }
  .nodes{
    position:absolute; inset:7% 7%; border-radius:50%;
    background:radial-gradient(closest-side, rgba(255,255,255,.12), transparent 70%);
    mask: radial-gradient(closest-side,#000 58%,transparent 59%), radial-gradient(farthest-side,#000 0,#000);
  }
  .dot{position:absolute; width:8px; height:8px; border-radius:50%;
    background: radial-gradient(circle, #fff 0, #fff 35%, transparent 36%);
    filter: drop-shadow(0 0 6px #fff);
  }
  @keyframes orbitA { from{ offset-distance: 0%; } to{ offset-distance: 100%; } }

  .pulse{ position:absolute; inset:0; border-radius:50%; pointer-events:none; opacity:.0; }
  .speaking .pulse{
    animation: speakPulse 1.6s ease-in-out infinite;
  }
  @keyframes speakPulse {
    0%{ box-shadow: 0 0 0 0 rgba(155,135,245,.50), 0 0 40px 10px rgba(155,135,245,.25) inset; opacity:.9; filter:hue-rotate(0deg);}
    50%{ box-shadow: 0 0 0 34px rgba(167,255,235,0), 0 0 66px 24px rgba(255,210,243,.25) inset; opacity:.75; filter:hue-rotate(35deg);}
    100%{ box-shadow: 0 0 0 0 rgba(155,135,245,0), 0 0 40px 10px rgba(138,180,255,.25) inset; opacity:.9; filter:hue-rotate(70deg);}
  }
  .listening .halo{
    animation: listenGlow 2.2s ease-in-out infinite;
  }
  @keyframes listenGlow{
    0%{ box-shadow: 0 0 140px 40px rgba(138,180,255,.16) inset, 0 0 220px 44px rgba(179,139,255,.11) inset; filter:hue-rotate(0deg) saturate(1.1);}
    50%{ box-shadow: 0 0 210px 80px rgba(167,255,235,.20) inset, 0 0 270px 70px rgba(255,210,243,.15) inset; filter:hue-rotate(30deg) saturate(1.28);}
    100%{ box-shadow: 0 0 140px 40px rgba(138,180,255,.16) inset, 0 0 220px 44px rgba(179,139,255,.11) inset; filter:hue-rotate(0deg) saturate(1.1);}
  }

  .cta{
    position: absolute; left:50%; top: calc(100% + 24px); transform: translateX(-50%);
    color:#cfd7ff; font-weight:500; font-size:14px; opacity:.9; text-align:center; line-height:1.4;
  }
  .heard{
    position:absolute; width:100%; left:0; top:-26px; text-align:center; font-size:13px; color:var(--muted);
  }

  .status{
    position:fixed; inset:auto 16px 16px auto; padding:10px 14px; border:1px solid var(--glass);
    border-radius:12px; background:rgba(255,255,255,.05); backdrop-filter: blur(8px);
    font-size:13px; opacity:.85; max-width:46ch;
  }
</style>
</head>
<body>
  <div class="hud">
    <span class="badge">Engine:</span>
    <select id="engine">
      <option value="eleven" selected>ElevenLabs (US Whisper)</option>
      <option value="browser">Browser Fallback (en-US)</option>
    </select>
    <button id="test">Test Voice</button>
    <span class="badge">Tap the glowing orbit to talk • tap again to stop</span>
  </div>

  <div class="wrap">
    <div class="field" id="orbWrap" aria-label="Talk to VERA">
      <div class="halo"></div>
      <div class="nodes" id="nodes"></div>
      <div class="pulse"></div>
      <div class="heard" id="heard"></div>
      <div class="cta" id="cta">I’m here. Tap to speak. I’ll listen, then answer.</div>
    </div>
  </div>

  <div class="status" id="status">idle</div>
  <audio id="out" preload="auto"></audio>

<script>
(function(){
  const out = document.getElementById('out');
  const orbWrap = document.getElementById('orbWrap');
  const statusEl = document.getElementById('status');
  const engineSel = document.getElementById('engine');
  const testBtn = document.getElementById('test');
  const heardEl = document.getElementById('heard');

  function sayStatus(s){ statusEl.textContent = s; }

  // draw neuron dots on flowing paths
  const nodes = document.getElementById('nodes');
  const paths = [
    "path('M 50 260 C 160 40, 460 40, 570 260 S 460 480, 290 410 S 50 260, 50 260')",
    "path('M 80 140 C 210 40, 460 60, 520 210 S 410 380, 260 340 S 100 220, 80 140')",
    "path('M 150 460 C 320 380, 420 380, 510 460 S 450 520, 330 510 S 200 520, 150 460')",
    "path('M 120 300 C 220 160, 420 160, 560 300 S 450 420, 300 420 S 160 380, 120 300')"
  ];
  for (let i=0;i<28;i++){
    const d = document.createElement('div');
    d.className = 'dot';
    const p = paths[i % paths.length];
    d.style.offsetPath = p;
    d.style.offsetDistance = (Math.random()*100).toFixed(2)+'%';
    d.style.animation = `orbitA ${18 + Math.random()*12}s linear infinite`;
    d.style.filter = `drop-shadow(0 0 6px rgba(255,255,255,.55)) hue-rotate(${Math.floor(Math.random()*70)}deg)`;
    nodes.appendChild(d);
  }

  // conversation memory (sent to server /api/chat)
  const history = []; // {role:'user'|'assistant', content:string}

  // mic
  let listening = false;
  let speaking = false;
  let mediaStream; let mediaRecorder; let chunks = [];

  async function startMic(){
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(mediaStream);
    chunks = [];
    mediaRecorder.ondataavailable = (e)=>{ if(e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = handleUserAudio;
    mediaRecorder.start();
  }
  function stopMic(){
    if(mediaRecorder && mediaRecorder.state !== 'inactive'){ mediaRecorder.stop(); }
    if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); }
  }

  // util: blob -> base64
  function blobToBase64(blob){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = ()=> res(String(fr.result).split(',')[1]);
      fr.onerror = rej;
      fr.readAsDataURL(blob);
    });
  }

  // speak (primary ElevenLabs via /api/vera-voice; fallback browser en-US)
  async function speak(text){
    try{
      if (engineSel.value === 'browser') throw new Error('force-fallback');
      const r = await fetch('/api/vera-voice', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ text, stylePreset: "whisper" })
      });
      if(!r.ok) throw new Error('tts-failed');
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      out.src = url;
      await out.play();
      out.onended = () => { URL.revokeObjectURL(url); orbWrap.classList.remove('speaking'); speaking=false; sayStatus('idle'); };
      return;
    }catch(_){
      const synth = window.speechSynthesis;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.93; u.pitch = 1.07; u.lang = 'en-US';
      function pickUSVoice(){
        const vs = synth.getVoices() || [];
        const prefer = vs.find(v => v.lang === 'en-US' && /female|samantha|us|ariel|serena|nova|america|alloy/i.test(v.name));
        return prefer || vs.find(v=>v.lang==='en-US') || vs[0] || null;
      }
      function go(){ u.voice = pickUSVoice(); synth.cancel(); synth.speak(u); }
      if (synth.getVoices().length === 0) synth.onvoiceschanged = go; else go();
      u.onend = ()=>{ orbWrap.classList.remove('speaking'); speaking=false; sayStatus('idle'); };
    }
  }

  // send audio → STT → text → send to chat → reply → speak
  async function handleUserAudio(){
    sayStatus('transcribing…'); orbWrap.classList.remove('listening');
    try{
      const blob = new Blob(chunks, { type: mediaRecorder?.mimeType || 'audio/webm' });
      const b64 = await blobToBase64(blob);

      const stt = await fetch('/api/stt', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ audio:b64, mime: blob.type || 'audio/webm' })
      });
      const sttJson = await stt.json();
      const userText = (stt.ok && sttJson?.text) ? String(sttJson.text).trim() : "";

      heardEl.textContent = userText ? `You: “${userText.slice(0,140)}${userText.length>140?'…':''}”` : '';
      if (!userText){
        speaking = true; orbWrap.classList.add('speaking'); sayStatus('speaking');
        await speak("I couldn't quite hear that. Try again, love—slow and easy.");
        return;
      }

      history.push({ role:'user', content:userText });

      sayStatus('thinking…');
      const chat = await fetch('/api/chat', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ history: history.slice(-8) }) // last turns
      });
      const chatJson = await chat.json();
      const reply = (chat.ok && chatJson?.reply) ? String(chatJson.reply).trim() : "I’m here. Where does this live in your body—front/back, left/right, surface/deep?";

      history.push({ role:'assistant', content: reply });

      speaking = true; orbWrap.classList.add('speaking'); sayStatus('speaking');
      await speak(reply);
    }catch(e){
      console.error(e);
      speaking = true; orbWrap.classList.add('speaking'); sayStatus('speaking');
      await speak("Something glitched on my side. We’ll try again.");
    }
  }

  // tap orbit → toggle listening or stop speech
  orbWrap.addEventListener('click', async ()=>{
    if (speaking){
      out.pause(); out.currentTime = 0; window.speechSynthesis?.cancel();
      orbWrap.classList.remove('speaking'); speaking=false; sayStatus('idle'); return;
    }
    if(!listening){
      sayStatus('listening…'); listening=true; orbWrap.classList.add('listening'); heardEl.textContent='';
      await startMic();
    }else{
      sayStatus('processing…'); listening=false; stopMic();
    }
  });

  // test voice
  testBtn.addEventListener('click', ()=>{
    speaking=true; orbWrap.classList.add('speaking'); sayStatus('speaking');
    speak("This is VERA in a soft American whisper. I’m right here with you. Breathe with me for four counts… one… two… three… four.");
  });

})();
</script>
</body>
</html>
