<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VERA — Speak & Be Held</title>
<meta name="description" content="Tap the living orb, speak to VERA, and receive a soothing, voiced response with somatic intelligence." />

<style>
  :root{
    --bg-deep:#070a1a;
    --bg-mid:#0e1430;
    --glass:rgba(255,255,255,.06);
    --line:rgba(255,255,255,.08);
    --text:rgba(255,255,255,.92);
    --soft:rgba(255,255,255,.70);
    --muted:rgba(255,255,255,.45);
    --c1:#9B59B6; /* amethyst */
    --c2:#64B5F6; /* neural blue */
    --c3:#F8BBD0; /* glow pink */
    --c4:#10B981; /* emerald */
    --c5:#FFD700; /* soft gold */
    --orb-a: #c79bff;
    --orb-b: #6bc9ff;
    --orb-ring: rgba(155,89,182,.35);
  }

  * { box-sizing:border-box; margin:0; padding:0; }
  html, body { height:100%; }
  body{
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 50% -10%, #1b2150 0%, transparent 60%),
      radial-gradient(900px 600px at 80% 10%, #0a1a3a 0%, transparent 55%),
      linear-gradient(180deg, var(--bg-mid), var(--bg-deep) 55%, #000 100%);
    overflow:hidden;
  }

  /* Cosmic field */
  .field{ position:fixed; inset:0; z-index:0; pointer-events:none; }
  .spark{
    position:absolute; width:2px; height:2px; border-radius:50%;
    background:radial-gradient(circle, #fff, rgba(255,255,255,0));
    opacity:.8; filter:drop-shadow(0 0 8px rgba(255,255,255,.55));
    animation: drift linear infinite;
  }
  @keyframes drift {
    0% { transform:translate3d(var(--x), var(--y), 0) scale(1); opacity:.2; }
    50% { opacity:.9; }
    100% { transform:translate3d(calc(var(--x) + var(--dx)), calc(var(--y) + var(--dy)), 0) scale(1.1); opacity:.2; }
  }

  /* Header */
  .top{
    position:fixed; top:0; left:0; right:0; height:64px; z-index:3;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 20px; backdrop-filter: blur(12px);
    background:linear-gradient(180deg, rgba(7,10,26,.75), rgba(7,10,26,.35));
    border-bottom:1px solid var(--line);
  }
  .brand{
    letter-spacing:.35em; font-weight:300; font-size:20px;
    background:linear-gradient(90deg, var(--c3), var(--c1), var(--c2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    user-select:none; cursor:pointer;
  }
  .status{
    font-size:13px; color:var(--muted);
  }

  /* Center stage */
  .stage{
    position:relative; z-index:2;
    height:100dvh; display:grid; place-items:center; padding-top:24px;
  }

  /* The Orb */
  .orb-wrap{
    position:relative; width:min(78vmin,560px); aspect-ratio:1/1;
    display:grid; place-items:center; cursor:pointer; user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .hint{
    position:absolute; bottom:-56px; left:50%; transform:translateX(-50%);
    font-size:14px; color:var(--soft);
    opacity:.85;
  }

  .orb{
    width:100%; height:100%; border-radius:50%;
    background:
      radial-gradient(120% 120% at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%),
      conic-gradient(from 0deg, var(--orb-a), var(--orb-b), var(--c3), var(--c2), var(--c1), var(--c4), var(--c5), var(--orb-a));
    box-shadow:
      inset 0 0 120px rgba(255,255,255,.08),
      0 0 120px rgba(123, 97, 255, .20),
      0 0 240px rgba(75, 229, 255, .18);
    position:relative;
    transition: transform .25s ease, filter .25s ease;
    transform: perspective(800px) rotateX(14deg);
    pointer-events:auto;
  }
  .orb::before{
    content:""; position:absolute; inset:-18px; border-radius:50%;
    background: radial-gradient(closest-side, rgba(155,89,182,.28), rgba(100,181,246,.18), rgba(0,0,0,0));
    filter: blur(18px);
  }

  /* Rings */
  .rings{
    position:absolute; inset:-6%; border-radius:50%; pointer-events:none;
    background:
      radial-gradient(closest-side, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
      conic-gradient(from 0deg, rgba(255,255,255,.0), rgba(255,255,255,.15), rgba(255,255,255,.0) 60%);
    mask: radial-gradient(closest-side, rgba(0,0,0,0) 68%, rgba(0,0,0,1) 72%, rgba(0,0,0,1) 82%, rgba(0,0,0,0) 86%);
    animation: slowspin 16s linear infinite;
  }
  @keyframes slowspin { to { transform: rotate(360deg); } }

  /* States */
  .orb-wrap.listening .orb{
    transform: perspective(800px) rotateX(0deg) scale(1.02);
    filter: drop-shadow(0 0 22px rgba(100,181,246,.35));
    animation: pulse 1.3s ease-in-out infinite;
  }
  .orb-wrap.speaking .orb{ animation: speakglow 1.2s ease-in-out infinite; }
  @keyframes pulse { 50%{ box-shadow: inset 0 0 150px rgba(255,255,255,.10), 0 0 160px rgba(100,181,246,.35); } }
  @keyframes speakglow {
    0%   { box-shadow: inset 0 0 160px rgba(255,255,255,.12), 0 0 220px rgba(155,89,182,.40); }
    50%  { box-shadow: inset 0 0 160px rgba(255,255,255,.12), 0 0 240px rgba(248,187,208,.45); }
    100% { box-shadow: inset 0 0 160px rgba(255,255,255,.12), 0 0 220px rgba(100,181,246,.42); }
  }

  /* Transcript glass */
  .glass{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
    width:min(90vw, 980px);
    padding:14px 16px; border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border:1px solid var(--line);
    backdrop-filter: blur(12px);
    color:var(--soft); font-size:14px; line-height:1.5;
    z-index:3; max-height:28dvh; overflow:auto;
  }
  .row{ display:flex; gap:10px; margin:6px 0; align-items:flex-start; }
  .tag{ font-size:12px; color:var(--muted); min-width:60px; text-align:right; }
  .bubble{
    flex:1; padding:10px 12px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid var(--line);
    color:var(--text);
  }

  .controls{
    position:fixed; right:16px; top:72px; z-index:4;
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .btn{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:var(--text); font-size:13px; padding:8px 10px; border-radius:10px;
    cursor:pointer;
  }
  .btn:hover{ background:rgba(255,255,255,.10); }
  .pill{
    padding:7px 10px; border-radius:999px; font-size:12px; color:#111;
    background:linear-gradient(90deg, #ffd66b, #ffa646);
    box-shadow:0 6px 22px rgba(255,166,70,.25);
  }

  /* Accessibility focus */
  .orb-wrap:focus-visible { outline: 2px solid #8ecfff; outline-offset: 6px; border-radius: 50%; }
</style>
</head>
<body>
  <!-- cosmic particles -->
  <div class="field" id="field"></div>

  <header class="top">
    <div class="brand" onclick="location.href='/'">VERA</div>
    <div class="status">
      <span id="status">idle</span>
      &nbsp;•&nbsp;<span class="pill">Tap the orb and speak</span>
    </div>
    <div class="controls">
      <button class="btn" id="toggle-voice">Voice: ElevenLabs</button>
      <button class="btn" id="clear">Clear</button>
    </div>
  </header>

  <main class="stage">
    <button class="orb-wrap" id="orbWrap" aria-label="Tap to speak with VERA" title="Tap to speak with VERA">
      <div class="orb" id="orb"></div>
      <div class="rings"></div>
      <div class="hint">Tap to speak • VERA will answer out loud</div>
    </button>
  </main>

  <!-- transcript -->
  <section class="glass" id="log" aria-live="polite"></section>

  <!-- hidden audio for TTS -->
  <audio id="voice" preload="auto" playsinline></audio>

<script>
/* ========= particles ========= */
(function seedStars(){
  const host = document.getElementById('field');
  const N = 160;
  const rnd = (a,b)=>Math.random()*(b-a)+a;
  for(let i=0;i<N;i++){
    const s = document.createElement('div');
    s.className = 'spark';
    const x = rnd(-50, window.innerWidth+50);
    const y = rnd(-50, window.innerHeight+50);
    const dx = rnd(-80, 80), dy = rnd(-60, 60);
    s.style.setProperty('--x', x+'px');
    s.style.setProperty('--y', y+'px');
    s.style.setProperty('--dx', dx+'px');
    s.style.setProperty('--dy', dy+'px');
    s.style.animationDuration = rnd(18, 42)+'s';
    s.style.opacity = Math.random()*.9+.1;
    host.appendChild(s);
  }
})();

/* ========= state ========= */
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const orbWrap = document.getElementById('orbWrap');
const orb = document.getElementById('orb');
const audioEl = document.getElementById('voice');
const btnToggleVoice = document.getElementById('toggle-voice');
const btnClear = document.getElementById('clear');

let usingElevenLabs = true; // default to ElevenLabs (better quality)
let listening = false;
let speaking = false;

// Conversation memory (kept on client and sent with each request)
let history = [
  { role:'system', content:
    "You are VERA, a warm somatic intelligence that speaks in short, steady phrases. " +
    "You always ask one gentle follow-up to help map sensations (location, texture, temperature, movement). " +
    "Voice-friendly: keep sentences ~12-18 words. Avoid lists. No emojis." }
];

/* ========= helpers ========= */
function sayStatus(s){ statusEl.textContent = s; }
function addRow(tag, text){
  const row = document.createElement('div'); row.className='row';
  const t = document.createElement('div'); t.className='tag'; t.textContent = tag;
  const b = document.createElement('div'); b.className='bubble'; b.textContent = text;
  row.appendChild(t); row.appendChild(b); logEl.appendChild(row);
  logEl.scrollTop = logEl.scrollHeight;
}
function setOrbPalette(a,b){
  orb.style.setProperty('--orb-a', a);
  orb.style.setProperty('--orb-b', b);
}
const palettes = [
  ['#c79bff','#6bc9ff'],
  ['#f8bbd0','#9b59b6'],
  ['#8ef6ff','#ffd66b'],
  ['#64b5f6','#10b981'],
  ['#ffd1f2','#b4b3ff']
];
function randomPalette(){ return palettes[Math.floor(Math.random()*palettes.length)]; }

/* ========= voice output ========= */
async function speak(text){
  // palette bloom while speaking
  const [a,b] = randomPalette();
  setOrbPalette(a,b);

  orbWrap.classList.add('speaking');
  speaking = true; sayStatus('speaking');

  // Try ElevenLabs first (server proxy). If it fails, fallback to speechSynthesis
  if(usingElevenLabs){
    try{
      const res = await fetch('/api/vera-voice', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ text })
      });
      if(!res.ok) throw new Error('TTS failed');
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      audioEl.src = url;
      await audioEl.play(); // user already interacted by tapping orb
      audioEl.onended = () => {
        URL.revokeObjectURL(url);
        orbWrap.classList.remove('speaking');
        speaking = false; sayStatus('idle');
      };
      return;
    }catch(err){
      console.warn('ElevenLabs failed, using speechSynthesis fallback:', err);
    }
  }
  // Fallback: browser TTS (try to pick a female voice)
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = 0.93; utter.pitch = 1.07;
  const pickVoice = () => {
    const vs = synth.getVoices();
    let v = vs.find(v=>/female|samantha|victoria|google uk english female/i.test(v.name)) || vs[0];
    if(v) utter.voice = v;
    synth.speak(utter);
  };
  if (synth.getVoices().length === 0) {
    synth.onvoiceschanged = pickVoice;
  } else {
    pickVoice();
  }
  utter.onend = () => {
    orbWrap.classList.remove('speaking');
    speaking = false; sayStatus('idle');
  };
}

/* ========= STT (speech -> text) ========= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;
if(SR){
  rec = new SR();
  rec.lang = 'en-US';
  rec.continuous = false; // single utterance, then stop
  rec.interimResults = false;

  rec.onstart = () => { listening = true; sayStatus('listening'); orbWrap.classList.add('listening'); };
  rec.onerror = (e) => {
    console.warn('recognition error', e);
    listening = false; orbWrap.classList.remove('listening'); sayStatus('idle');
  };
  rec.onend = () => {
    listening = false; orbWrap.classList.remove('listening'); if(!speaking) sayStatus('idle');
  };
  rec.onresult = (e) => {
    const text = (e.results[0] && e.results[0][0] && e.results[0][0].transcript) || '';
    if(!text) return;
    addRow('You', text);
    history.push({role:'user', content:text});
    chat(text);
  };
}else{
  addRow('System', 'Speech recognition is not supported in this browser.');
}

/* ========= Chat (OpenAI) ========= */
async function chat(text){
  try{
    const payload = { messages: history.slice(-12) }; // keep last context small
    const r = await fetch('/api/vera-chat', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('chat api failed'); }
    const data = await r.json();
    const reply = (data && data.text) || "I'm here with you.";
    history.push({role:'assistant', content:reply});
    addRow('VERA', reply);
    await speak(reply);
  }catch(err){
    console.error(err);
    const fallback = "I'm here. Slow everything down with me. Where in your body is most alive right now?";
    history.push({role:'assistant', content:fallback});
    addRow('VERA', fallback);
    await speak(fallback);
  }
}

/* ========= interactions ========= */
async function handleTap(){
  if(speaking){ /* ignore taps while speaking */ return; }
  if(!rec){ addRow('System','Mic not available.'); return; }
  if(!listening){
    try{ await rec.start(); }catch(e){ console.warn(e); }
  }else{
    try{ rec.stop(); }catch(e){ console.warn(e); }
  }
}
orbWrap.addEventListener('click', handleTap);
orbWrap.addEventListener('touchend', (e)=>{ e.preventDefault(); handleTap(); }, {passive:false});
window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); handleTap(); }});

/* ========= UI buttons ========= */
btnToggleVoice.addEventListener('click', ()=>{
  usingElevenLabs = !usingElevenLabs;
  btnToggleVoice.textContent = 'Voice: ' + (usingElevenLabs ? 'ElevenLabs' : 'Browser');
});
btnClear.addEventListener('click', ()=>{
  logEl.innerHTML = '';
  history = history.slice(0,1);
  sayStatus('idle');
});

/* ========= greet ========= */
addRow('VERA', 'Hi. I am with you. Tap the orb and tell me what you notice in your body.');
(async()=>{ 
  try{
    await speak('Hi. I am with you. Tap the orb and tell me what you notice in your body.');
  }catch(_){}
})();
</script>
</body>
</html>
