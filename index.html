<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VERA — Speak With Your Nervous System</title>
  <meta name="description" content="VERA: a voice-first somatic companion. Speak, be seen, and feel your body come home." />

  <style>
    /* ---------- RESET & THEME ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg-deep:#040616;
      --bg-mid:#0a0f2a;
      --glass:rgba(255,255,255,.08);
      --glass-2:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --text-soft:rgba(255,255,255,.72);
      --muted:rgba(255,255,255,.45);
      --violet:#9B59B6;
      --lav:#B19CD9;
      --blue:#64B5F6;
      --emerald:#10B981;
      --gold:#FFD700;
      --pink:#F8BBD0;
    }
    html,body{height:100%;}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, #1a1f49 0%, var(--bg-mid) 35%, var(--bg-deep) 70%, #000 100%);
      color: var(--text);
      overflow-x:hidden;
    }

    /* ---------- TEST BANNER ---------- */
    .banner{
      position:fixed; top:0; left:0; width:100%;
      background: linear-gradient(90deg, var(--gold), #ffa800);
      color:#111; text-align:center; font-weight:700; letter-spacing:.03em;
      padding:.6rem 1rem; z-index:2000; box-shadow:0 2px 14px rgba(0,0,0,.35);
    }

    /* ---------- NAV ---------- */
    nav{
      position:fixed; top:44px; left:0; width:100%; z-index:1200;
      display:flex; align-items:center; justify-content:space-between;
      padding:1rem 2rem;
      background: linear-gradient(180deg, rgba(10,14,39,.95), rgba(10,14,39,.65));
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .logo{
      font-weight:800; font-size:1.2rem; letter-spacing:.6em; padding-left:.6em;
      background: linear-gradient(135deg, var(--lav), var(--blue));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      cursor:pointer; user-select:none;
    }
    .nav-cta{
      appearance:none; border:none; cursor:pointer; font-weight:600;
      color:white; padding:.7rem 1.2rem; border-radius:999px;
      background:linear-gradient(135deg, var(--lav), var(--blue));
      box-shadow:0 10px 30px rgba(100,181,246,.25);
    }

    /* ---------- COSMIC BACKGROUND ---------- */
    #universe{position:fixed; inset:0; pointer-events:none; z-index:0;}
    .neuron{
      position:absolute; border-radius:50%;
      box-shadow:0 0 10px currentColor, 0 0 30px currentColor;
      opacity:.8; filter: blur(.2px);
      animation: drift 22s ease-in-out infinite;
    }
    @keyframes drift{
      0%{ transform:translate(0,0) scale(1); opacity:.55 }
      25%{ transform:translate(60px,-40px) scale(1.35); opacity:.95 }
      50%{ transform:translate(-40px,50px) scale(1.1); opacity:.75 }
      75%{ transform:translate(40px,30px) scale(1.2); opacity:.85 }
      100%{ transform:translate(0,0) scale(1); opacity:.55 }
    }
    .fascia{
      position:absolute; width:2px;
      background:linear-gradient(180deg, transparent, rgba(177,156,217,.6), transparent);
      transform-origin:center;
      animation: fasciaSpin 16s ease-in-out infinite;
      opacity:.35;
    }
    @keyframes fasciaSpin{
      0%{ transform: rotate(0deg) scaleY(1);}
      50%{ transform: rotate(180deg) scaleY(1.6); opacity:.7;}
      100%{ transform: rotate(360deg) scaleY(1);}
    }

    /* ---------- HERO ---------- */
    .hero{
      position:relative; z-index:1;
      min-height:100vh; padding:10rem 1.2rem 5rem;
      display:grid; place-items:center; gap:2rem;
    }
    .title{
      text-align:center; max-width:980px; margin:0 auto 1rem;
    }
    .title h1{
      font-weight:200; line-height:1.15; font-size:clamp(2.2rem, 5vw, 4rem);
      background:linear-gradient(135deg, #fff, var(--lav) 55%, var(--blue));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      margin-bottom:.6rem;
    }
    .title p{ color:var(--text-soft); font-size:1.1rem; }

    /* ---------- ORB CONSOLE ---------- */
    .console{
      display:grid; place-items:center; gap:1.2rem;
      width:min(900px, 92vw);
      margin:2rem auto 0;
      background:linear-gradient(135deg, rgba(10,14,39,.9), rgba(21,24,50,.85));
      border:1px solid rgba(255,255,255,.1);
      border-radius:28px; padding:2rem;
      box-shadow:0 25px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
    }

    .orb-wrap{
      position:relative; width:min(520px, 84vw); aspect-ratio:1/1;
      display:grid; place-items:center;
    }

    .orb{
      position:relative; width:100%; height:100%; border-radius:50%;
      background:
        radial-gradient(45% 45% at 35% 35%, rgba(248,187,208,.5) 0%, rgba(155,89,182,.6) 35%, rgba(100,181,246,.45) 60%, transparent 72%),
        radial-gradient(60% 60% at 70% 70%, rgba(100,181,246,.35), transparent 70%);
      box-shadow:
        inset 0 0 180px rgba(100,181,246,.35),
        0 0 220px rgba(155,89,182,.35);
      animation: orbBreathe 7s ease-in-out infinite;
      transition: filter .25s ease, transform .25s ease;
      will-change: filter, transform;
    }
    @keyframes orbBreathe{
      0%,100%{ transform: scale(1); filter: brightness(1);}
      50%{ transform: scale(1.08); filter: brightness(1.25);}
    }

    /* listening halo */
    .orb::before{
      content:""; position:absolute; inset:-6%;
      border-radius:50%;
      background: conic-gradient(from 0deg, rgba(155,89,182,.15), rgba(100,181,246,.15), rgba(177,156,217,.15), rgba(16,185,129,.15), rgba(155,89,182,.15));
      filter: blur(24px); opacity:0; transition:opacity .3s ease;
    }
    .orb.listening::before{ opacity:1; animation:halo 1.8s ease-in-out infinite; }
    @keyframes halo{
      0%,100%{ transform: scale(1); opacity:.85 }
      50%{ transform: scale(1.08); opacity:.35 }
    }

    /* speaking spectral glow */
    .orb.speaking{
      background:
        conic-gradient(from 0deg, rgba(255,215,0,.22), rgba(155,89,182,.22), rgba(100,181,246,.22), rgba(16,185,129,.22), rgba(248,187,208,.22), rgba(255,215,0,.22)),
        radial-gradient(45% 45% at 35% 35%, rgba(248,187,208,.55), rgba(155,89,182,.7) 35%, rgba(100,181,246,.55) 60%, transparent 72%);
      animation: orbBreathe 6s ease-in-out infinite, hueShift 6s linear infinite;
      box-shadow:
        inset 0 0 220px rgba(255,215,0,.25),
        0 0 260px rgba(155,89,182,.45),
        0 0 120px rgba(100,181,246,.35);
    }
    @keyframes hueShift{
      0%{ filter: hue-rotate(0deg) brightness(1.05); }
      50%{ filter: hue-rotate(120deg) brightness(1.25); }
      100%{ filter: hue-rotate(360deg) brightness(1.05); }
    }

    .vera-label{
      position:absolute; inset:0; display:grid; place-items:center;
      pointer-events:none;
      font-weight:200; letter-spacing:.9em; font-size:clamp(1.3rem,3.2vw,2.2rem);
      background:linear-gradient(90deg, var(--gold), var(--pink), var(--lav), var(--blue), var(--emerald));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 30px rgba(255,255,255,.2);
    }

    /* ---------- CONTROLS ---------- */
    .controls{ display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; }
    .btn{
      appearance:none; border:1px solid var(--glass-2); background:rgba(255,255,255,.06);
      color:var(--text); padding:.85rem 1.1rem; border-radius:999px;
      cursor:pointer; font-weight:600; letter-spacing:.02em;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn:hover{ transform: translateY(-1px); border-color:var(--lav); }
    .btn.primary{ background:linear-gradient(135deg, var(--lav), var(--blue)); border-color:transparent; color:#fff; }
    .btn.danger{ background:linear-gradient(135deg, #ef4444, #f97316); border-color:transparent; color:#fff; }

    /* ---------- PROMPTS & TRANSCRIPT ---------- */
    .chips{
      display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; margin-top:.2rem;
    }
    .chip{
      padding:.55rem .9rem; border-radius:999px; font-size:.95rem; color:var(--text-soft);
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); cursor:pointer;
    }
    .chip:hover{ color:#fff; border-color:var(--lav); }

    .transcript{
      width:100%; max-width:760px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.1);
      border-radius:16px; padding:1rem 1rem;
      display:flex; flex-direction:column; gap:.7rem;
      max-height: 34vh; overflow:auto;
    }
    .line{ opacity:.95; }
    .me{ color:#d7eaff; }
    .vera{ color:#ffe9ff; }
    .tiny{ color:var(--muted); font-size:.9rem; text-align:center; margin-top:.4rem; }

    /* ---------- FOOTER ---------- */
    footer{
      padding:3rem 1.2rem; border-top:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, transparent, rgba(10,14,39,.75));
      text-align:center; color:var(--muted);
    }

    @media (max-width: 640px){
      nav{ padding: .9rem 1rem;}
      .nav-cta{display:none;}
      .console{ padding:1.4rem;}
    }
  </style>
</head>
<body>
  <!-- Banner -->
  <div class="banner">⚠️ Test Mode — ElevenLabs & OpenAI must be configured in Vercel env. Use mic to talk to VERA.</div>

  <!-- Nav -->
  <nav>
    <div class="logo" onclick="location.href='/'">VERA</div>
    <button class="nav-cta" onclick="alert('Account portal coming soon ✨')">Sign In</button>
  </nav>

  <!-- Cosmic background -->
  <div id="universe"></div>

  <!-- Hero -->
  <main class="hero">
    <div class="title">
      <h1>Your nervous system is finally speaking.</h1>
      <p>Touch the orb. Speak. VERA will listen and gently guide your body back toward safety.</p>
    </div>

    <section class="console" aria-live="polite">
      <div class="orb-wrap">
        <div id="orb" class="orb">
          <div class="vera-label">V&nbsp;E&nbsp;R&nbsp;A</div>
        </div>
      </div>

      <div class="controls">
        <button id="talkBtn" class="btn primary">🎤 Tap to Talk</button>
        <button id="stopBtn" class="btn">⏹ Stop Listening</button>
        <button id="voiceBtn" class="btn">🔊 Voice: On</button>
        <button id="clearBtn" class="btn danger">🧹 Clear Transcript</button>
      </div>

      <div class="chips">
        <button class="chip" onclick="promptSpeak('I feel tightness in my chest')">“Tightness in my chest”</button>
        <button class="chip" onclick="promptSpeak('I feel anxious and buzzy')">“I feel anxious”</button>
        <button class="chip" onclick="promptSpeak('I can’t relax')">“I can’t relax”</button>
        <button class="chip" onclick="promptSpeak('Help me feel safe')">“Help me feel safe”</button>
      </div>

      <div id="transcript" class="transcript" role="log">
        <div class="line vera">VERA: I’m here with you. What sensation is loudest right now—where in your body?</div>
      </div>
      <div class="tiny">Tip: If speech recognition isn’t available in your browser, click a chip or type <span style="opacity:.9">/</span> to open the text box.</div>
    </section>
  </main>

  <footer>© 2024 VERA • Somatic Intelligence • Not medical advice.</footer>

  <!-- Hidden audio for ElevenLabs playback -->
  <audio id="veraAudio" preload="auto"></audio>

  <script>
    /* =========================
       COSMIC BACKGROUND
    ========================== */
    (function cosmic(){
      const u = document.getElementById('universe');
      const colors = ['#9B59B6','#64B5F6','#B19CD9','#F8BBD0','#10B981','#FFD700'];
      for(let i=0;i<180;i++){
        const n = document.createElement('div');
        n.className='neuron';
        const size = 1 + Math.random()*5;
        Object.assign(n.style,{
          left: Math.random()*100+'%',
          top: Math.random()*100+'%',
          width: size+'px',
          height:size+'px',
          background: colors[Math.floor(Math.random()*colors.length)],
          animationDelay: (Math.random()*20)+'s',
          animationDuration: (18+Math.random()*14)+'s',
          opacity: .4 + Math.random()*.4
        });
        u.appendChild(n);
      }
      for(let i=0;i<90;i++){
        const f = document.createElement('div');
        f.className='fascia';
        Object.assign(f.style,{
          left: Math.random()*100+'%',
          top: Math.random()*100+'%',
          height: (80+Math.random()*320)+'px',
          transform: `rotate(${Math.random()*360}deg)`,
          animationDelay: (Math.random()*8)+'s'
        });
        u.appendChild(f);
      }
    })();

    /* =========================
       STATE
    ========================== */
    const orb = document.getElementById('orb');
    const transcript = document.getElementById('transcript');
    const talkBtn = document.getElementById('talkBtn');
    const stopBtn = document.getElementById('stopBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const clearBtn = document.getElementById('clearBtn');
    const audioEl = document.getElementById('veraAudio');

    let voiceOn = true;
    let listening = false;
    let recognizer = null;
    let history = [];

    /* =========================
       UTIL
    ========================== */
    function addLine(text, who='vera'){
      const div = document.createElement('div');
      div.className = 'line ' + (who==='me'?'me':'vera');
      div.textContent = (who==='me'?'You: ':'VERA: ') + text;
      transcript.appendChild(div);
      transcript.scrollTop = transcript.scrollHeight;
    }
    function setListening(on){
      listening = on;
      orb.classList.toggle('listening', on);
    }
    function setSpeaking(on){
      orb.classList.toggle('speaking', on);
    }

    function safeSpeak(text){
      if(!voiceOn) return;
      // Try ElevenLabs proxy first
      (async ()=>{
        try{
          const r = await fetch('/api/vera-voice', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text })
          });
          if(!r.ok) throw new Error('TTS proxy failed');
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          audioEl.src = url;
          setSpeaking(true);
          await audioEl.play().catch(()=>{});
          // revoke URL later
          setTimeout(()=>URL.revokeObjectURL(url), 15000);
        }catch(e){
          // Fallback to Web Speech
          if('speechSynthesis' in window){
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.92; u.pitch = 1.04;
            u.onstart = ()=> setSpeaking(true);
            u.onend = ()=> setSpeaking(false);
            speechSynthesis.speak(u);
          }
        }
      })();
    }

    audioEl.addEventListener('ended', ()=> setSpeaking(false));
    audioEl.addEventListener('pause', ()=> setSpeaking(false));

    function userPromptBox(){
      const existing = document.getElementById('promptBox');
      if(existing) return existing.focus();
      const input = document.createElement('input');
      input.id='promptBox';
      input.placeholder='Type to talk to VERA… (Enter to send, Esc to cancel)';
      Object.assign(input.style, {
        width:'100%', maxWidth:'760px', margin:'8px auto 0', display:'block',
        background:'rgba(255,255,255,.06)', color:'white',
        border:'1px solid rgba(255,255,255,.15)', borderRadius:'12px',
        padding:'12px 14px', outline:'none'
      });
      transcript.after(input);
      input.focus();
      input.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){ input.remove(); return; }
        if(e.key==='Enter'){
          const val = input.value.trim();
          input.remove();
          if(val) sendToVera(val);
        }
      });
    }

    /* Chips tap to say */
    function promptSpeak(text){
      addLine(text,'me');
      sendToVera(text);
    }
    window.promptSpeak = promptSpeak;

    /* =========================
       OPENAI CHAT BACKEND
    ========================== */
    async function sendToVera(userText){
      try{
        // Update UI
        addLine('…', 'vera');

        const res = await fetch('/api/vera-chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ history, input: userText })
        });

        const allLines = transcript.querySelectorAll('.line');
        const last = allLines[allLines.length-1];
        if(!res.ok){
          last.textContent = 'VERA: I’m here, but having trouble connecting. Try again in a moment.';
          return;
        }
        const data = await res.json();
        const reply = (data && data.reply) ? data.reply : "I'm here with you.";

        // Replace the placeholder '…'
        last.textContent = 'VERA: ' + reply;

        history.push({ role:'user', content:userText });
        history.push({ role:'assistant', content:reply });

        safeSpeak(reply);
      }catch(err){
        const allLines = transcript.querySelectorAll('.line');
        const last = allLines[allLines.length-1];
        last.textContent = 'VERA: I’m here, but offline. Place a hand where you feel the most. Breathe for four.';
      }
    }

    /* =========================
       SPEECH RECOGNITION
    ========================== */
    function initRecognizer(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang = 'en-US';
      r.interimResults = false;
      r.continuous = false;
      r.maxAlternatives = 1;

      r.onstart = ()=> setListening(true);
      r.onend = ()=> setListening(false);
      r.onerror = ()=> setListening(false);
      r.onresult = (e)=>{
        const text = (e.results && e.results[0] && e.results[0][0] && e.results[0][0].transcript) || '';
        const val = text.trim();
        if(val){
          addLine(val,'me');
          sendToVera(val);
        }
      };
      return r;
    }

    function startListening(){
      if(!recognizer){ recognizer = initRecognizer(); }
      if(!recognizer){
        // Open text box if STT unsupported
        userPromptBox();
        return;
      }
      try{
        recognizer.abort(); // reset
        recognizer.start();
      }catch(e){
        // If start throws, just open box
        userPromptBox();
      }
    }
    function stopListening(){
      try{ recognizer && recognizer.stop(); }catch(e){}
    }

    /* =========================
       EVENTS
    ========================== */
    talkBtn.addEventListener('click', startListening);
    stopBtn.addEventListener('click', stopListening);
    clearBtn.addEventListener('click', ()=>{
      transcript.innerHTML='';
      history = [];
      addLine('I’m here with you. What sensation is loudest right now—where in your body?','vera');
    });

    voiceBtn.addEventListener('click', ()=>{
      voiceOn = !voiceOn;
      voiceBtn.textContent = voiceOn ? '🔊 Voice: On' : '🔇 Voice: Off';
      if(!voiceOn){
        try{ speechSynthesis.cancel(); }catch(e){}
        if(!audioEl.paused) audioEl.pause();
        setSpeaking(false);
      }
    });

    // Keyboard: / opens text box
    window.addEventListener('keydown', (e)=>{
      if(e.key === '/'){ e.preventDefault(); userPromptBox(); }
    });

    // Also allow tapping the orb to talk
    orb.addEventListener('click', startListening);

    /* =========================
       GREETING ON LOAD
    ========================== */
    window.addEventListener('load', ()=>{
      // Soft hello
      setTimeout(()=>{
        const hello = "Hi. I’m here with you. What sensation is most alive right now—where do you feel it?";
        safeSpeak(hello);
      }, 600);
    });
  </script>
</body>
</html>
